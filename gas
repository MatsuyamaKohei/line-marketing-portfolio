/**
 * スクリプト名: 美容室予約フォーム スプレッドシート転記システム
 * 概要: LIFFフォームからのPOSTを受け取り、予約の新規作成・変更・キャンセルを行う
 *
 * 事前準備:
 * 1. 本スクリプトを「デプロイ」→「新しいデプロイ」→「ウェブアプリ」として公開
 * 2. アクセスを「全員」に設定
 * 3. 公開したURLをindex.htmlのGAS_URLに貼り付け
 *
 * ※スプレッドシートの「予約台帳」シートは以下の列構成になります:
 *   予約ID | 受信日時 | 更新日時 | ユーザーID | 名前 | 予約日時 | メニュー | ステータス
 *   既存データがある場合は一度シートを削除してから再デプロイしてください。
 */

const CONFIG = {
  SHEET_NAME: '予約台帳',
};

/**
 * LIFFフォームからのPOSTを受け取るメイン関数
 * action: 'new' | 'update' | 'cancel'
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const { action, userId, userName, reservationDate, menu, reservationId } = data;

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(CONFIG.SHEET_NAME);

    if (!sheet) {
      sheet = ss.insertSheet(CONFIG.SHEET_NAME);
      sheet.appendRow(['予約ID', '受信日時', '更新日時', 'ユーザーID', '名前', '予約日時', 'メニュー', 'ステータス']);
    }

    const now = Utilities.formatDate(new Date(), 'JST', 'yyyy/MM/dd HH:mm:ss');

    // 新規予約
    if (action === 'new') {
      const newId = generateId();
      sheet.appendRow([newId, now, now, userId, userName, reservationDate, menu, '予約済']);
      return okResponse({ result: 'ok', reservationId: newId });
    }

    // 変更 or キャンセル: 予約IDで行を検索
    const allData = sheet.getDataRange().getValues();
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] === reservationId) {
        const rowNum = i + 1;
        if (action === 'update') {
          sheet.getRange(rowNum, 3).setValue(now);            // 更新日時
          sheet.getRange(rowNum, 5).setValue(userName);       // 名前
          sheet.getRange(rowNum, 6).setValue(reservationDate); // 予約日時
          sheet.getRange(rowNum, 7).setValue(menu);           // メニュー
        } else if (action === 'cancel') {
          sheet.getRange(rowNum, 3).setValue(now);            // 更新日時
          sheet.getRange(rowNum, 8).setValue('キャンセル');    // ステータス
        }
        return okResponse({ result: 'ok' });
      }
    }

    return errorResponse('予約が見つかりませんでした');

  } catch (err) {
    console.error('エラー発生: ' + err.stack);
    return errorResponse(err.message);
  }
}

/**
 * LIFFフォームからのGETを受け取る関数
 * クエリパラメータ: ?userId=xxx
 * 戻り値: { oldName, reservation: { id, userName, reservationDate, menu } | null }
 */
function doGet(e) {
  try {
    const userId = e.parameter.userId;
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CONFIG.SHEET_NAME);

    if (!sheet || !userId) {
      return okResponse({ oldName: null, reservation: null });
    }

    const data = sheet.getDataRange().getValues();
    let reservation = null;
    let oldName = null;

    // 下から検索して最新データを取得
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][3] === userId) {
        if (!oldName) oldName = String(data[i][4]);
        if (!reservation && data[i][7] === '予約済') {
          // 予約日時: Dateオブジェクトの場合はdatetime-local形式に変換
          let rawDate = data[i][5];
          const reservationDateTime = rawDate instanceof Date ? rawDate : new Date(rawDate);

          // 予約日時が過去の場合はスキップ（施術済みとみなす）
          if (reservationDateTime <= new Date()) continue;

          let reservationDateStr;
          if (rawDate instanceof Date) {
            reservationDateStr = Utilities.formatDate(rawDate, 'JST', "yyyy-MM-dd'T'HH:mm");
          } else {
            reservationDateStr = String(rawDate);
          }
          reservation = {
            id: String(data[i][0]),
            userName: String(data[i][4]),
            reservationDate: reservationDateStr,
            menu: String(data[i][6])
          };
        }
        if (oldName && reservation) break;
      }
    }

    return okResponse({ oldName, reservation });

  } catch (err) {
    console.error('エラー発生: ' + err.stack);
    return okResponse({ oldName: null, reservation: null });
  }
}

function generateId() {
  return new Date().getTime().toString(36) + Math.random().toString(36).substr(2, 5);
}

function okResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function errorResponse(message) {
  return ContentService
    .createTextOutput(JSON.stringify({ result: 'error', message }))
    .setMimeType(ContentService.MimeType.JSON);
}
