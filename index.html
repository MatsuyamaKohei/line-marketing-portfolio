<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美容室予約フォーム</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #00b900;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        #loading {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        /* 既存予約カード */
        #existingView {
            background: #f0fff0;
            border: 1px solid #00b900;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        #existingView h3 {
            margin: 0 0 12px;
            font-size: 1em;
            color: #00b900;
        }

        #existingView dl {
            margin: 0 0 16px;
        }

        #existingView dt {
            font-size: 0.8em;
            color: #888;
            margin-top: 8px;
        }

        #existingView dd {
            margin: 2px 0 0;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
        }

        /* モーダル共通 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-box {
            background: #fff;
            border-radius: 10px;
            padding: 24px;
            width: 88%;
            max-width: 360px;
        }

        .modal-box h3 {
            margin: 0 0 16px;
            font-size: 1.1em;
            text-align: center;
        }

        .modal-box p {
            text-align: center;
            color: #666;
            margin: 0 0 20px;
        }

        .modal-box dl {
            margin: 0 0 20px;
        }

        .modal-box dt {
            font-size: 0.8em;
            color: #888;
            margin-top: 10px;
        }

        .modal-box dd {
            margin: 2px 0 0;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
        }

        .btn-gray {
            background: #ccc;
        }

        .btn-danger {
            background: #ff4444;
        }

        /* 送信中オーバーレイ */
        #sendingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        #sendingOverlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <h2>予約フォーム</h2>
    <div id="loading">LINEログイン中...</div>

    <!-- 既存予約表示 -->
    <div id="existingView" style="display:none">
        <h3>現在のご予約</h3>
        <dl>
            <dt>お名前</dt>
            <dd id="existName"></dd>
            <dt>ご希望日時</dt>
            <dd id="existDate"></dd>
            <dt>メニュー</dt>
            <dd id="existMenu"></dd>
        </dl>
        <div class="action-buttons">
            <button id="editBtn" type="button">変更する</button>
            <button id="cancelReservationBtn" type="button" class="btn-danger">キャンセルする</button>
        </div>
    </div>

    <!-- 予約フォーム -->
    <form id="reservationForm" style="display:none">
        <div class="form-group">
            <label>お名前</label>
            <input type="text" id="userName" placeholder="お名前を入力" required>
        </div>
        <div class="form-group">
            <label>ご希望日時</label>
            <input type="datetime-local" id="reservationDate" required>
        </div>
        <div class="form-group">
            <label>メニュー</label>
            <select id="menu">
                <option value="カット">カット</option>
                <option value="カット＋カラー">カット＋カラー</option>
                <option value="髪質改善トリートメント">髪質改善トリートメント</option>
            </select>
        </div>
        <button type="submit" id="submitBtn">予約を確定する</button>
    </form>

    <!-- 確認モーダル -->
    <div id="confirmModal" class="modal">
        <div class="modal-box">
            <h3 id="confirmTitle">予約内容の確認</h3>
            <dl>
                <dt>お名前</dt>
                <dd id="confirmName"></dd>
                <dt>ご希望日時</dt>
                <dd id="confirmDate"></dd>
                <dt>メニュー</dt>
                <dd id="confirmMenu"></dd>
            </dl>
            <div class="modal-buttons">
                <button id="confirmBackBtn" type="button" class="btn-gray">戻る</button>
                <button id="confirmBtn" type="button">この内容で確定する</button>
            </div>
        </div>
    </div>

    <!-- キャンセル確認モーダル -->
    <div id="cancelModal" class="modal">
        <div class="modal-box">
            <h3>予約をキャンセルしますか？</h3>
            <p>この操作は元に戻せません。</p>
            <div class="modal-buttons">
                <button id="cancelModalBackBtn" type="button" class="btn-gray">戻る</button>
                <button id="cancelModalConfirmBtn" type="button" class="btn-danger">キャンセルする</button>
            </div>
        </div>
    </div>

    <!-- 送信中オーバーレイ -->
    <div id="sendingOverlay">
        <div class="spinner"></div>
        <p>送信中...</p>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxqdS2KfwpL8PuqlbRaPPgyrh7FNAPtLPpMDZw-O2UIa9UdDiH0JdtsyM_BwjrJ2PSeVg/exec";
        const LIFF_ID = "2009216134-x9TsRzm8";

        let currentUserId = null;
        let formMode = 'new'; // 'new' | 'edit'
        let currentReservation = null; // { id, userName, reservationDate, menu }

        const confirmModal = document.getElementById('confirmModal');
        const cancelModal = document.getElementById('cancelModal');
        const sendingOverlay = document.getElementById('sendingOverlay');

        function showSending() { sendingOverlay.classList.add('active'); }
        function hideSending() { sendingOverlay.classList.remove('active'); }

        function formatDate(value) {
            if (!value) return "";
            const d = new Date(value);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function showExistingView(reservation) {
            currentReservation = reservation;
            document.getElementById('existName').innerText = reservation.userName;
            document.getElementById('existDate').innerText = formatDate(reservation.reservationDate);
            document.getElementById('existMenu').innerText = reservation.menu;
            document.getElementById('existingView').style.display = 'block';
            document.getElementById('reservationForm').style.display = 'none';
        }

        function showForm(reservation, mode) {
            formMode = mode;
            if (mode === 'edit') {
                currentReservation = reservation;
                document.getElementById('userName').value = reservation.userName;
                document.getElementById('reservationDate').value = reservation.reservationDate;
                document.getElementById('menu').value = reservation.menu;
                document.getElementById('submitBtn').innerText = '変更を確定する';
                document.getElementById('confirmTitle').innerText = '変更内容の確認';
            } else {
                document.getElementById('userName').value = reservation.defaultName || '';
                document.getElementById('reservationDate').value = '';
                document.getElementById('submitBtn').innerText = '予約を確定する';
                document.getElementById('confirmTitle').innerText = '予約内容の確認';
            }
            document.getElementById('existingView').style.display = 'none';
            document.getElementById('reservationForm').style.display = 'block';
        }

        // フォームsubmit → 確認モーダル表示
        document.getElementById('reservationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentUserId) {
                alert('LINEログインが完了していません。ページを再読み込みしてください。');
                return;
            }
            document.getElementById('confirmName').innerText = document.getElementById('userName').value;
            document.getElementById('confirmDate').innerText = formatDate(document.getElementById('reservationDate').value);
            document.getElementById('confirmMenu').innerText = document.getElementById('menu').value;
            confirmModal.classList.add('active');
        });

        // 確認モーダル「戻る」
        document.getElementById('confirmBackBtn').addEventListener('click', () => {
            confirmModal.classList.remove('active');
        });

        // 確認モーダル「確定する」（新規 or 変更）
        document.getElementById('confirmBtn').addEventListener('click', async () => {
            confirmModal.classList.remove('active');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            showSending();

            const postData = {
                action: formMode === 'edit' ? 'update' : 'new',
                userId: currentUserId,
                userName: document.getElementById('userName').value,
                reservationDate: document.getElementById('reservationDate').value,
                menu: document.getElementById('menu').value,
                reservationId: currentReservation ? currentReservation.id : null
            };

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(postData)
                });
                hideSending();
                alert(formMode === 'edit' ? '予約を変更しました！' : '予約が完了しました！');
            } catch (error) {
                console.error('Fetch error:', error);
                hideSending();
                alert('エラーが発生しました。もう一度お試しください。');
                submitBtn.disabled = false;
                return;
            }

            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                submitBtn.disabled = false;
                submitBtn.innerText = '完了（LINEアプリで開いてください）';
            }
        });

        // 「変更する」ボタン
        document.getElementById('editBtn').addEventListener('click', () => {
            showForm(currentReservation, 'edit');
        });

        // 「キャンセルする」ボタン
        document.getElementById('cancelReservationBtn').addEventListener('click', () => {
            cancelModal.classList.add('active');
        });

        // キャンセルモーダル「戻る」
        document.getElementById('cancelModalBackBtn').addEventListener('click', () => {
            cancelModal.classList.remove('active');
        });

        // キャンセルモーダル「キャンセルする」
        document.getElementById('cancelModalConfirmBtn').addEventListener('click', async () => {
            cancelModal.classList.remove('active');
            const btn = document.getElementById('cancelModalConfirmBtn');
            btn.disabled = true;
            showSending();

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'cancel',
                        userId: currentUserId,
                        reservationId: currentReservation.id
                    })
                });
                hideSending();
                alert('予約をキャンセルしました。');
            } catch (error) {
                console.error('Fetch error:', error);
                hideSending();
                alert('エラーが発生しました。もう一度お試しください。');
                btn.disabled = false;
                return;
            }

            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.location.reload();
            }
        });

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
            } catch (e) {
                console.error('LIFF init error:', e);
                document.getElementById('loading').innerText = '初期化に失敗しました。ページを再読み込みしてください。';
                return;
            }

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            try {
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                const defaultName = profile.displayName;

                document.getElementById('loading').innerText = '予約情報を確認中...';

                try {
                    const response = await fetch(`${GAS_URL}?userId=${currentUserId}`);
                    const data = await response.json();

                    if (data.reservation) {
                        // 既存の有効予約あり
                        showExistingView(data.reservation);
                        document.getElementById('loading').innerText = '';
                    } else {
                        // 新規
                        showForm({ defaultName: data.oldName || defaultName }, 'new');
                        document.getElementById('loading').innerText = data.oldName
                            ? 'おかえりなさい！入力を補助しました。'
                            : '初めまして！お名前を入力してください。';
                    }
                } catch (e) {
                    showForm({ defaultName }, 'new');
                    document.getElementById('loading').innerText = '準備ができました。';
                }
            } catch (e) {
                console.error('Profile error:', e);
                document.getElementById('loading').innerText = 'プロフィールの取得に失敗しました。';
            }
        }

        main();
    </script>
</body>

</html>