<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美容室予約フォーム</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #00b900;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        #loading {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        /* 既存予約カード */
        #existingView {
            background: #f0fff0;
            border: 1px solid #00b900;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        #existingView h3 {
            margin: 0 0 12px;
            font-size: 1em;
            color: #00b900;
        }

        #existingView dl {
            margin: 0 0 16px;
        }

        #existingView dt {
            font-size: 0.8em;
            color: #888;
            margin-top: 8px;
        }

        #existingView dd {
            margin: 2px 0 0;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
        }

        /* モーダル共通 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-box {
            background: #fff;
            border-radius: 10px;
            padding: 24px;
            width: 88%;
            max-width: 360px;
        }

        .modal-box h3 {
            margin: 0 0 16px;
            font-size: 1.1em;
            text-align: center;
        }

        .modal-box p {
            text-align: center;
            color: #666;
            margin: 0 0 20px;
        }

        .modal-box dl {
            margin: 0 0 20px;
        }

        .modal-box dt {
            font-size: 0.8em;
            color: #888;
            margin-top: 10px;
        }

        .modal-box dd {
            margin: 2px 0 0;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
        }

        .btn-gray {
            background: #ccc;
        }

        .btn-danger {
            background: #ff4444;
        }

        /* カレンダーナビ */
        #calendarNav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        #calendarNav button {
            width: auto;
            padding: 6px 12px;
            font-size: 13px;
            background: #eee;
            color: #333;
        }

        #calendarNav button:disabled {
            opacity: 0.3;
            cursor: default;
        }

        #calendarRange {
            font-size: 0.9em;
            color: #555;
        }

        #calendarWrapper {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: 46px repeat(7, minmax(40px, 1fr));
            min-width: 326px;
        }

        .cal-time-header {
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            border-right: 1px solid #eee;
        }

        .cal-header {
            background: #f5f5f5;
            text-align: center;
            padding: 5px 2px;
            font-size: 0.72em;
            border-bottom: 2px solid #ddd;
            border-right: 1px solid #eee;
            line-height: 1.4;
        }

        .cal-header.cal-today {
            background: #e6ffe6;
            color: #00b900;
            font-weight: bold;
        }

        .cal-header.cal-sunday {
            color: #e53935;
        }

        .cal-header.cal-saturday {
            color: #1e88e5;
        }

        .cal-time-label {
            font-size: 0.62em;
            color: #aaa;
            text-align: right;
            padding: 0 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #eee;
            background: #fafafa;
            height: 36px;
            box-sizing: border-box;
        }

        .cal-slot {
            height: 36px;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #eee;
            box-sizing: border-box;
        }

        .cal-slot.available {
            background: #fff;
            cursor: pointer;
        }

        .cal-slot.available:active {
            background: #e6ffe6;
        }

        .cal-slot.unavailable {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .cal-slot.selected {
            background: #00b900;
        }

        #selectedSlotDisplay {
            margin-top: 10px;
            font-size: 0.9em;
            color: #00b900;
            font-weight: bold;
            min-height: 20px;
        }

        #calendarLoadingMsg {
            padding: 16px;
            text-align: center;
            color: #888;
            font-size: 0.9em;
        }

        /* 送信中オーバーレイ */
        #sendingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        #sendingOverlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <h2>予約フォーム</h2>
    <div id="loading">LINEログイン中...</div>

    <!-- 既存予約表示 -->
    <div id="existingView" style="display:none">
        <h3>現在のご予約</h3>
        <dl>
            <dt>お名前</dt>
            <dd id="existName"></dd>
            <dt>ご希望日時</dt>
            <dd id="existDate"></dd>
            <dt>メニュー</dt>
            <dd id="existMenu"></dd>
        </dl>
        <div class="action-buttons">
            <button id="editBtn" type="button">変更する</button>
            <button id="cancelReservationBtn" type="button" class="btn-danger">キャンセルする</button>
        </div>
    </div>

    <!-- 予約フォーム -->
    <form id="reservationForm" style="display:none">
        <div class="form-group">
            <label>お名前</label>
            <input type="text" id="userName" placeholder="お名前を入力" required>
        </div>
        <div class="form-group">
            <label>ご希望日時</label>
            <div id="calendarNav">
                <button type="button" id="prevWeek">◀ 前の週</button>
                <span id="calendarRange"></span>
                <button type="button" id="nextWeek">次の週 ▶</button>
            </div>
            <div id="calendarWrapper">
                <div id="calendarLoadingMsg">読み込み中...</div>
                <div id="calendar"></div>
            </div>
            <div id="selectedSlotDisplay"></div>
        </div>
        <div class="form-group">
            <label>メニュー</label>
            <select id="menu">
                <option value="カット">カット</option>
                <option value="カット＋カラー">カット＋カラー</option>
                <option value="髪質改善トリートメント">髪質改善トリートメント</option>
            </select>
        </div>
        <button type="submit" id="submitBtn">予約を確定する</button>
    </form>

    <!-- 確認モーダル -->
    <div id="confirmModal" class="modal">
        <div class="modal-box">
            <h3 id="confirmTitle">予約内容の確認</h3>
            <dl>
                <dt>お名前</dt>
                <dd id="confirmName"></dd>
                <dt>ご希望日時</dt>
                <dd id="confirmDate"></dd>
                <dt>メニュー</dt>
                <dd id="confirmMenu"></dd>
            </dl>
            <div class="modal-buttons">
                <button id="confirmBackBtn" type="button" class="btn-gray">戻る</button>
                <button id="confirmBtn" type="button">この内容で確定する</button>
            </div>
        </div>
    </div>

    <!-- キャンセル確認モーダル -->
    <div id="cancelModal" class="modal">
        <div class="modal-box">
            <h3>予約をキャンセルしますか？</h3>
            <p>この操作は元に戻せません。</p>
            <div class="modal-buttons">
                <button id="cancelModalBackBtn" type="button" class="btn-gray">戻る</button>
                <button id="cancelModalConfirmBtn" type="button" class="btn-danger">キャンセルする</button>
            </div>
        </div>
    </div>

    <!-- 送信中オーバーレイ -->
    <div id="sendingOverlay">
        <div class="spinner"></div>
        <p>送信中...</p>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx2EeAjM6kcbtjgq4mA4d-IxUifkucKf0XNIuJVDyh_nRYgNs_6_P5xNGx6PWf2Km5dJw/exec";
        const LIFF_ID = "2009216134-x9TsRzm8";

        let currentUserId = null;
        let formMode = 'new'; // 'new' | 'edit'
        let currentReservation = null; // { id, userName, reservationDate, menu }

        const confirmModal = document.getElementById('confirmModal');
        const cancelModal = document.getElementById('cancelModal');
        const sendingOverlay = document.getElementById('sendingOverlay');

        const MENU_MAP = {
            '1': 'カット',
            '2': 'カット＋カラー',
            '3': '髪質改善トリートメント'
        };
        const urlMenuParam = new URLSearchParams(window.location.search).get('menu');

        function showSending() { sendingOverlay.classList.add('active'); }
        function hideSending() { sendingOverlay.classList.remove('active'); }

        // === カレンダー ===
        const OPEN_HOUR = 10;   // 営業開始
        const CLOSE_HOUR = 19;  // 営業終了（最終スロット 18:30）
        const DAY_NAMES = ['日', '月', '火', '水', '木', '金', '土'];
        let weekOffset = 0;
        let selectedSlot = null;
        let bookedSlotsCache = null;

        function getTimeSlots() {
            const slots = [];
            for (let h = OPEN_HOUR; h < CLOSE_HOUR; h++) {
                slots.push(`${String(h).padStart(2, '0')}:00`);
                slots.push(`${String(h).padStart(2, '0')}:30`);
            }
            return slots;
        }

        async function initCalendar() {
            document.getElementById('calendarLoadingMsg').style.display = 'block';
            document.getElementById('calendar').innerHTML = '';
            if (!bookedSlotsCache) {
                try {
                    const res = await fetch(`${GAS_URL}?type=slots`);
                    const data = await res.json();
                    bookedSlotsCache = new Set(data.bookedSlots || []);
                } catch (e) {
                    bookedSlotsCache = new Set();
                }
            }
            document.getElementById('calendarLoadingMsg').style.display = 'none';
            renderCalendar();
        }

        function renderCalendar() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const now = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() + weekOffset * 7);
            const days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                return d;
            });

            // ナビ更新
            const first = days[0], last = days[6];
            document.getElementById('calendarRange').textContent =
                `${first.getMonth() + 1}/${first.getDate()} 〜 ${last.getMonth() + 1}/${last.getDate()}`;
            document.getElementById('prevWeek').disabled = weekOffset <= 0;
            document.getElementById('nextWeek').disabled = weekOffset >= 3;

            const timeSlots = getTimeSlots();
            let html = '<div class="cal-grid">';

            // ヘッダー行
            html += '<div class="cal-time-header"></div>';
            days.forEach(d => {
                const isToday = d.getTime() === today.getTime();
                const idx = d.getDay();
                let cls = 'cal-header';
                if (idx === 0) cls += ' cal-sunday';
                if (idx === 6) cls += ' cal-saturday';
                if (isToday) cls += ' cal-today';
                html += `<div class="${cls}"><div>${DAY_NAMES[idx]}</div><div>${d.getMonth() + 1}/${d.getDate()}</div></div>`;
            });

            // 時間スロット行
            timeSlots.forEach(time => {
                html += `<div class="cal-time-label">${time}</div>`;
                days.forEach(d => {
                    const ymd = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const dt = `${ymd}T${time}`;
                    const isPast = new Date(dt) <= now;
                    const isBooked = bookedSlotsCache && bookedSlotsCache.has(dt);
                    const isSelected = selectedSlot === dt;
                    let cls = 'cal-slot';
                    if (isSelected) cls += ' selected';
                    else if (isPast || isBooked) cls += ' unavailable';
                    else cls += ' available';
                    html += `<div class="${cls}"${!isPast && !isBooked ? ` data-dt="${dt}"` : ''}></div>`;
                });
            });

            html += '</div>';
            document.getElementById('calendar').innerHTML = html;

            // クリックイベント
            document.querySelectorAll('#calendar .cal-slot.available').forEach(el => {
                el.addEventListener('click', () => {
                    selectedSlot = el.dataset.dt;
                    updateSelectedDisplay();
                    document.querySelectorAll('#calendar .cal-slot').forEach(s => {
                        s.classList.remove('selected');
                        if (s.classList.contains('available') || s === el) {
                            s.classList.add(s === el ? 'selected' : 'available');
                        }
                    });
                    el.classList.remove('available');
                    el.classList.add('selected');
                });
            });
        }

        function updateSelectedDisplay() {
            const el = document.getElementById('selectedSlotDisplay');
            el.textContent = selectedSlot ? `選択中: ${formatDate(selectedSlot)}` : '';
        }

        document.getElementById('prevWeek').addEventListener('click', () => {
            if (weekOffset > 0) { weekOffset--; renderCalendar(); }
        });
        document.getElementById('nextWeek').addEventListener('click', () => {
            if (weekOffset < 3) { weekOffset++; renderCalendar(); }
        });

        function formatDate(value) {
            if (!value) return "";
            const d = new Date(value);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function showExistingView(reservation) {
            currentReservation = reservation;
            document.getElementById('existName').innerText = reservation.userName;
            document.getElementById('existDate').innerText = formatDate(reservation.reservationDate);
            document.getElementById('existMenu').innerText = reservation.menu;
            document.getElementById('existingView').style.display = 'block';
            document.getElementById('reservationForm').style.display = 'none';
        }

        function showForm(reservation, mode) {
            formMode = mode;
            if (mode === 'edit') {
                currentReservation = reservation;
                document.getElementById('userName').value = reservation.userName;
                document.getElementById('menu').value = reservation.menu;
                document.getElementById('submitBtn').innerText = '変更を確定する';
                document.getElementById('confirmTitle').innerText = '変更内容の確認';
                // 予約済み日時の週にカレンダーを移動してスロットを選択
                const resDay = new Date(reservation.reservationDate);
                resDay.setHours(0, 0, 0, 0);
                const todayDay = new Date();
                todayDay.setHours(0, 0, 0, 0);
                weekOffset = Math.max(0, Math.floor((resDay - todayDay) / (1000 * 60 * 60 * 24 * 7)));
                selectedSlot = reservation.reservationDate;
            } else {
                document.getElementById('userName').value = reservation.defaultName || '';
                if (urlMenuParam && MENU_MAP[urlMenuParam]) {
                    document.getElementById('menu').value = MENU_MAP[urlMenuParam];
                }
                document.getElementById('submitBtn').innerText = '予約を確定する';
                document.getElementById('confirmTitle').innerText = '予約内容の確認';
                weekOffset = 0;
                selectedSlot = null;
            }
            updateSelectedDisplay();
            initCalendar();
            document.getElementById('existingView').style.display = 'none';
            document.getElementById('reservationForm').style.display = 'block';
        }

        // フォームsubmit → 確認モーダル表示
        document.getElementById('reservationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentUserId) {
                alert('LINEログインが完了していません。ページを再読み込みしてください。');
                return;
            }
            if (!selectedSlot) {
                alert('日時を選択してください。');
                return;
            }
            document.getElementById('confirmName').innerText = document.getElementById('userName').value;
            document.getElementById('confirmDate').innerText = formatDate(selectedSlot);
            document.getElementById('confirmMenu').innerText = document.getElementById('menu').value;
            confirmModal.classList.add('active');
        });

        // 確認モーダル「戻る」
        document.getElementById('confirmBackBtn').addEventListener('click', () => {
            confirmModal.classList.remove('active');
        });

        // 確認モーダル「確定する」（新規 or 変更）
        document.getElementById('confirmBtn').addEventListener('click', async () => {
            confirmModal.classList.remove('active');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            showSending();

            const postData = {
                action: formMode === 'edit' ? 'update' : 'new',
                userId: currentUserId,
                userName: document.getElementById('userName').value,
                reservationDate: selectedSlot,
                menu: document.getElementById('menu').value,
                reservationId: currentReservation ? currentReservation.id : null
            };

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(postData)
                });
                hideSending();
                alert(formMode === 'edit' ? '予約を変更しました！' : '予約が完了しました！');
            } catch (error) {
                console.error('Fetch error:', error);
                hideSending();
                alert('エラーが発生しました。もう一度お試しください。');
                submitBtn.disabled = false;
                return;
            }

            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                submitBtn.disabled = false;
                submitBtn.innerText = '完了（LINEアプリで開いてください）';
            }
        });

        // 「変更する」ボタン
        document.getElementById('editBtn').addEventListener('click', () => {
            showForm(currentReservation, 'edit');
        });

        // 「キャンセルする」ボタン
        document.getElementById('cancelReservationBtn').addEventListener('click', () => {
            cancelModal.classList.add('active');
        });

        // キャンセルモーダル「戻る」
        document.getElementById('cancelModalBackBtn').addEventListener('click', () => {
            cancelModal.classList.remove('active');
        });

        // キャンセルモーダル「キャンセルする」
        document.getElementById('cancelModalConfirmBtn').addEventListener('click', async () => {
            cancelModal.classList.remove('active');
            const btn = document.getElementById('cancelModalConfirmBtn');
            btn.disabled = true;
            showSending();

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'cancel',
                        userId: currentUserId,
                        reservationId: currentReservation.id
                    })
                });
                hideSending();
                alert('予約をキャンセルしました。');
            } catch (error) {
                console.error('Fetch error:', error);
                hideSending();
                alert('エラーが発生しました。もう一度お試しください。');
                btn.disabled = false;
                return;
            }

            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.location.reload();
            }
        });

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
            } catch (e) {
                console.error('LIFF init error:', e);
                document.getElementById('loading').innerText = '初期化に失敗しました。ページを再読み込みしてください。';
                return;
            }

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            try {
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                const defaultName = profile.displayName;

                document.getElementById('loading').innerText = '予約情報を確認中...';

                try {
                    const response = await fetch(`${GAS_URL}?userId=${currentUserId}`);
                    const data = await response.json();

                    if (data.reservation) {
                        // 既存の有効予約あり
                        showExistingView(data.reservation);
                        document.getElementById('loading').innerText = '';
                    } else {
                        // 新規
                        showForm({ defaultName: data.oldName || defaultName }, 'new');
                        document.getElementById('loading').innerText = data.oldName
                            ? 'おかえりなさい！入力を補助しました。'
                            : '初めまして！お名前を入力してください。';
                    }
                } catch (e) {
                    showForm({ defaultName }, 'new');
                    document.getElementById('loading').innerText = '準備ができました。';
                }
            } catch (e) {
                console.error('Profile error:', e);
                document.getElementById('loading').innerText = 'プロフィールの取得に失敗しました。';
            }
        }

        main();
    </script>
</body>

</html>